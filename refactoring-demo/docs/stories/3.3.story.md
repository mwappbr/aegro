# Story 3.3: Editar Tarefa

## Status
Draft

## Story
**As a** usuário,  
**I want** modificar tarefas existentes,  
**so that** eu possa atualizar detalhes e status conforme o trabalho progride

## Acceptance Criteria
1. Botão "Editar" em cada tarefa da lista
2. Modal ou página de edição com formulário pré-preenchido
3. Todos os campos editáveis: título, descrição, prioridade, data de vencimento, projeto, status
4. Validação de campos obrigatórios
5. Mudanças salvas no backend via API
6. Lista atualizada imediatamente após salvar
7. Opção de cancelar edição (fechar modal sem salvar)
8. Feedback visual durante salvamento (loading state)

## Tasks / Subtasks
- [ ] Task 1: Setup Backend - Endpoint de Atualização de Tarefa (AC: 3, 4, 5)
  - [ ] Adicionar rota PUT `/api/tasks/:id` em `server/src/routes/tasks.routes.ts`
  - [ ] Criar schema Zod `updateTaskSchema` em `server/src/validators/task.validator.ts` [Source: architecture/7-arquitetura-de-segurana.md#72-schemas-de-validao-zod]
  - [ ] Implementar função `updateTask()` em `server/src/services/task.service.ts` que:
    - Valida dados com Zod
    - Obtém userId do token JWT (via middleware auth)
    - Verifica que tarefa existe e pertence ao usuário (createdById = userId OU assignedToId = userId)
    - Atualiza tarefa no banco via Prisma
    - Retorna tarefa atualizada com relações
  - [ ] Adicionar tratamento de erros (404 se tarefa não existe ou não pertence ao usuário) [Source: architecture/9-estratgia-de-tratamento-de-erros.md#91-middleware-de-erro-servidor]
- [ ] Task 2: Setup Frontend - Modal de Edição (AC: 1, 2, 3, 4, 7, 8)
  - [ ] Criar componente `EditTaskModal` em `client/src/components/EditTaskModal/EditTaskModal.tsx`
  - [ ] Modal deve conter TaskForm pré-preenchido com dados da tarefa
  - [ ] Adicionar campo status (select dropdown: pending/in_progress/completed)
  - [ ] Implementar validação de campos obrigatórios
  - [ ] Adicionar botões: "Salvar" e "Cancelar"
  - [ ] Implementar fechamento do modal ao clicar em "Cancelar" ou fora do modal
  - [ ] Adicionar loading state durante salvamento
- [ ] Task 3: Integração com TaskCard e API (AC: 1, 5, 6)
  - [ ] Adicionar botão "Editar" no TaskCard que abre EditTaskModal
  - [ ] Criar função `updateTask()` em `client/src/api/tasks.ts` [Source: architecture/6-arquitetura-de-componentes-react.md#63-padro-do-cliente-api]
  - [ ] Integrar modal com API client
  - [ ] Atualizar lista de tarefas após edição (refetch ou atualizar estado)
  - [ ] Implementar tratamento de erros e mensagens de sucesso [Source: architecture/9-estratgia-de-tratamento-de-erros.md#92-tratamento-de-erro-cliente]
- [ ] Task 4: Integração e Testes (AC: Todos)
  - [ ] Testar fluxo completo: editar tarefa → modal → salvar → atualização da lista
  - [ ] Testar cancelamento (fechar modal sem salvar)
  - [ ] Testar validação de campos
  - [ ] Testar que apenas tarefas do usuário podem ser editadas (segurança)
  - [ ] Testar feedback visual durante salvamento

## Dev Notes

### Previous Story Insights
- Story 3.1 criou TaskCard e TaskList
- Story 3.2 criou TaskForm para criação
- Reutilizar TaskForm para edição (com pré-preenchimento)
- Reutilizar estrutura de rotas/services de tarefas

### Data Models
**Task Model** [Source: architecture/3-design-do-banco-de-dados.md#31-schema-prisma]
- Mesmo modelo das stories anteriores
- Todos os campos são editáveis exceto: id, createdAt, updatedAt (gerenciados automaticamente)

**Validação Zod para Atualização de Tarefa** [Source: architecture/7-arquitetura-de-segurana.md#72-schemas-de-validao-zod]
- Similar ao createTaskSchema, mas todos os campos opcionais (partial update)
- Validar que tarefa existe e pertence ao usuário

### API Specifications
**PUT /api/tasks/:id** [Source: architecture/4-design-da-api.md#tarefas]
- **Autenticação**: Requerida (JWT token)
- **Request Headers**: `Authorization: Bearer <token>`
- **Request Body** (todos os campos opcionais - partial update):
  ```json
  {
    "title": "Updated Title",
    "status": "in_progress",
    "priority": "high",
    "dueDate": "2026-01-30T00:00:00Z",
    "description": "Updated description",
    "projectId": 2
  }
  ```
- **Response 200**: Tarefa atualizada com relações
- **Erros**:
  - `400 Bad Request`: Dados inválidos
  - `401 Unauthorized`: Token ausente ou inválido
  - `404 Not Found`: Tarefa não existe ou não pertence ao usuário

### Component Specifications
**EditTaskModal Component** [Source: architecture/6-arquitetura-de-componentes-react.md#61-rvore-de-componentes]
- Localização: `client/src/components/EditTaskModal/EditTaskModal.tsx`
- Props:
  - `task: Task` - Tarefa a ser editada
  - `isOpen: boolean` - Controla visibilidade do modal
  - `onClose: () => void` - Callback para fechar modal
  - `onSuccess: () => void` - Callback após edição bem-sucedida
- Conteúdo:
  - TaskForm pré-preenchido com dados da tarefa
  - Campo adicional: status (select dropdown)
  - Botões: "Salvar" e "Cancelar"
  - Loading state durante salvamento

**TaskCard Update** [Source: architecture/6-arquitetura-de-componentes-react.md#61-rvore-de-componentes]
- Adicionar botão "Editar" que abre EditTaskModal
- Passar tarefa como prop para o modal

### File Locations
**Backend** [Source: architecture/2-estrutura-do-projeto.md#21-estrutura-de-diretrios]
- Rota: `server/src/routes/tasks.routes.ts` (adicionar rota PUT)
- Service: `server/src/services/task.service.ts` (adicionar função updateTask)
- Validator: `server/src/validators/task.validator.ts` (adicionar updateTaskSchema)

**Frontend** [Source: architecture/2-estrutura-do-projeto.md#21-estrutura-de-diretrios]
- Componente: `client/src/components/EditTaskModal/EditTaskModal.tsx` (novo)
- Componente: `client/src/components/TaskCard/TaskCard.tsx` (atualizar com botão editar)
- API Client: `client/src/api/tasks.ts` (adicionar função updateTask)
- Componente: `client/src/components/Modal/Modal.tsx` (reutilizar se existir, ou criar)

### Testing Requirements
**Backend Testing**
- Testes unitários para `task.service.updateTask()` (validação, atualização, verificação de ownership)
- Testes de integração para rota PUT `/api/tasks/:id`
- Testar que apenas tarefas do usuário podem ser editadas (segurança)
- Testar validação Zod
- Testar erro 404 se tarefa não existe ou não pertence ao usuário

**Frontend Testing**
- Testes de componente para `EditTaskModal.tsx`
- Testar pré-preenchimento do formulário
- Testar validação de campos
- Testar cancelamento (fechar modal)
- Testar integração com API client
- Testar atualização da lista após edição
- Testar feedback visual durante salvamento

### Technical Constraints
- **Segurança**: Verificar ownership antes de atualizar (createdById OU assignedToId = userId) [Source: architecture/7-arquitetura-de-segurana.md#71-controles-vs-vulnerabilidades-do-legado]
- **Partial Update**: Todos os campos opcionais no update (permitir atualizar apenas alguns campos) [Source: architecture/4-design-da-api.md#tarefas]
- **Modal**: Usar componente Modal reutilizável ou criar novo [Source: architecture/2-estrutura-do-projeto.md#21-estrutura-de-diretrios]
- **Validação**: Zod no backend, validação client-side opcional [Source: architecture/7-arquitetura-de-segurana.md#72-schemas-de-validao-zod]

### Project Structure Notes
EditTaskModal deve seguir padrão de componente por pasta. Reutilizar TaskForm se possível, ou criar versão editável.

## Testing

### Testing Standards
**Test File Location**
- Backend: `server/src/__tests__/` ou próximo aos arquivos
- Frontend: `client/src/__tests__/` ou próximo aos componentes

**Testing Frameworks**
- Backend: Jest
- Frontend: React Testing Library

**Testing Patterns**
- Testes unitários para services
- Testes de integração para rotas
- Testes de componente para EditTaskModal e TaskCard

**Specific Testing Requirements for This Story**
- Validar verificação de ownership (segurança)
- Validar partial update (atualizar apenas alguns campos)
- Validar todos os casos de erro (400, 401, 404)
- Validar atualização da lista após edição
- Validar cancelamento (fechar modal sem salvar)
- Validar feedback visual durante salvamento

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-XX | 1.0 | Story criada | Scrum Master |

## Dev Agent Record
*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*A ser preenchido*

### Debug Log References
*A ser preenchido*

### Completion Notes List
*A ser preenchido*

### File List
*A ser preenchido*

## QA Results
*Esta seção será preenchida pelo agente QA após revisão*
