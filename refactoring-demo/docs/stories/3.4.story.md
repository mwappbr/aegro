# Story 3.4: Excluir Tarefa

## Status
Draft

## Story
**As a** usuário,  
**I want** remover tarefas,  
**so that** eu possa limpar tarefas canceladas ou duplicadas

## Acceptance Criteria
1. Botão "Excluir" em cada tarefa
2. Diálogo de confirmação antes de excluir ("Tem certeza que deseja excluir esta tarefa?")
3. Opção de cancelar exclusão
4. Tarefa removida do banco de dados após confirmação
5. Tarefa removida da lista imediatamente
6. Mensagem de sucesso ("Tarefa excluída com sucesso")
7. Exclusão é permanente (não há lixeira/restauração)

## Tasks / Subtasks
- [ ] Task 1: Setup Backend - Endpoint de Exclusão de Tarefa (AC: 4)
  - [ ] Adicionar rota DELETE `/api/tasks/:id` em `server/src/routes/tasks.routes.ts`
  - [ ] Implementar função `deleteTask()` em `server/src/services/task.service.ts` que:
    - Obtém userId do token JWT (via middleware auth)
    - Verifica que tarefa existe e pertence ao usuário (createdById = userId OU assignedToId = userId)
    - Remove tarefa do banco via Prisma
    - Retorna sucesso
  - [ ] Adicionar tratamento de erros (404 se tarefa não existe ou não pertence ao usuário) [Source: architecture/9-estratgia-de-tratamento-de-erros.md#91-middleware-de-erro-servidor]
- [ ] Task 2: Setup Frontend - Diálogo de Confirmação (AC: 1, 2, 3)
  - [ ] Criar componente `ConfirmDialog` em `client/src/components/ConfirmDialog/ConfirmDialog.tsx` (reutilizável)
  - [ ] Diálogo deve exibir mensagem de confirmação
  - [ ] Adicionar botões: "Confirmar" e "Cancelar"
  - [ ] Implementar fechamento ao clicar em "Cancelar" ou fora do diálogo
- [ ] Task 3: Integração com TaskCard e API (AC: 1, 4, 5, 6)
  - [ ] Adicionar botão "Excluir" no TaskCard que abre ConfirmDialog
  - [ ] Criar função `deleteTask()` em `client/src/api/tasks.ts` [Source: architecture/6-arquitetura-de-componentes-react.md#63-padro-do-cliente-api]
  - [ ] Integrar diálogo com API client
  - [ ] Atualizar lista de tarefas após exclusão (remover do estado ou refetch)
  - [ ] Implementar mensagem de sucesso [Source: architecture/9-estratgia-de-tratamento-de-erros.md#92-tratamento-de-erro-cliente]
  - [ ] Adicionar loading state durante exclusão
- [ ] Task 4: Integração e Testes (AC: Todos)
  - [ ] Testar fluxo completo: excluir tarefa → confirmação → exclusão → atualização da lista
  - [ ] Testar cancelamento (fechar diálogo sem excluir)
  - [ ] Testar que apenas tarefas do usuário podem ser excluídas (segurança)
  - [ ] Testar mensagem de sucesso
  - [ ] Verificar que exclusão é permanente (não há lixeira)

## Dev Notes

### Previous Story Insights
- Story 3.1 criou TaskCard e TaskList
- Story 3.3 adicionou botão "Editar" no TaskCard
- Reutilizar padrão de botões e integração com API
- Reutilizar estrutura de rotas/services de tarefas

### Data Models
**Task Model** [Source: architecture/3-design-do-banco-de-dados.md#31-schema-prisma]
- Exclusão permanente via Prisma `delete()`
- Não há soft delete (não há campo deletedAt)
- Relações: onDelete SetNull para projectId e assignedToId (não afeta tarefa)

### API Specifications
**DELETE /api/tasks/:id** [Source: architecture/4-design-da-api.md#tarefas]
- **Autenticação**: Requerida (JWT token)
- **Request Headers**: `Authorization: Bearer <token>`
- **Response 200**:
  ```json
  {
    "success": true
  }
  ```
- **Erros**:
  - `401 Unauthorized`: Token ausente ou inválido
  - `404 Not Found`: Tarefa não existe ou não pertence ao usuário

### Component Specifications
**ConfirmDialog Component** [Source: architecture/6-arquitetura-de-componentes-react.md#61-rvore-de-componentes]
- Localização: `client/src/components/ConfirmDialog/ConfirmDialog.tsx`
- Props:
  - `isOpen: boolean` - Controla visibilidade do diálogo
  - `title: string` - Título do diálogo
  - `message: string` - Mensagem de confirmação
  - `onConfirm: () => void` - Callback ao confirmar
  - `onCancel: () => void` - Callback ao cancelar
- Renderização:
  - Mensagem de confirmação
  - Botões: "Confirmar" e "Cancelar"
  - Fechar ao clicar fora ou em "Cancelar"

**TaskCard Update** [Source: architecture/6-arquitetura-de-componentes-react.md#61-rvore-de-componentes]
- Adicionar botão "Excluir" que abre ConfirmDialog
- Passar callback de confirmação que chama API deleteTask

### File Locations
**Backend** [Source: architecture/2-estrutura-do-projeto.md#21-estrutura-de-diretrios]
- Rota: `server/src/routes/tasks.routes.ts` (adicionar rota DELETE)
- Service: `server/src/services/task.service.ts` (adicionar função deleteTask)

**Frontend** [Source: architecture/2-estrutura-do-projeto.md#21-estrutura-de-diretrios]
- Componente: `client/src/components/ConfirmDialog/ConfirmDialog.tsx` (novo)
- Componente: `client/src/components/TaskCard/TaskCard.tsx` (atualizar com botão excluir)
- API Client: `client/src/api/tasks.ts` (adicionar função deleteTask)

### Testing Requirements
**Backend Testing**
- Testes unitários para `task.service.deleteTask()` (verificação de ownership, exclusão)
- Testes de integração para rota DELETE `/api/tasks/:id`
- Testar que apenas tarefas do usuário podem ser excluídas (segurança)
- Testar erro 404 se tarefa não existe ou não pertence ao usuário
- Verificar que exclusão é permanente (tarefa não existe mais no banco)

**Frontend Testing**
- Testes de componente para `ConfirmDialog.tsx`
- Testes de componente para `TaskCard.tsx` (botão excluir)
- Testar abertura do diálogo
- Testar cancelamento (fechar diálogo)
- Testar confirmação (chamar API)
- Testar atualização da lista após exclusão
- Testar mensagem de sucesso

### Technical Constraints
- **Segurança**: Verificar ownership antes de excluir (createdById OU assignedToId = userId) [Source: architecture/7-arquitetura-de-segurana.md#71-controles-vs-vulnerabilidades-do-legado]
- **Exclusão Permanente**: Não há soft delete, exclusão é definitiva [Source: architecture/3-design-do-banco-de-dados.md#31-schema-prisma]
- **Confirmação**: Sempre mostrar diálogo de confirmação antes de excluir (UX)
- **Feedback**: Mostrar mensagem de sucesso após exclusão

### Project Structure Notes
ConfirmDialog deve seguir padrão de componente por pasta e ser reutilizável para outras confirmações futuras.

## Testing

### Testing Standards
**Test File Location**
- Backend: `server/src/__tests__/` ou próximo aos arquivos
- Frontend: `client/src/__tests__/` ou próximo aos componentes

**Testing Frameworks**
- Backend: Jest
- Frontend: React Testing Library

**Testing Patterns**
- Testes unitários para services
- Testes de integração para rotas
- Testes de componente para ConfirmDialog e TaskCard

**Specific Testing Requirements for This Story**
- Validar verificação de ownership (segurança)
- Validar exclusão permanente (tarefa não existe mais)
- Validar todos os casos de erro (401, 404)
- Validar atualização da lista após exclusão
- Validar cancelamento (fechar diálogo sem excluir)
- Validar mensagem de sucesso

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-XX | 1.0 | Story criada | Scrum Master |

## Dev Agent Record
*Esta seção será preenchida pelo agente de desenvolvimento durante a implementação*

### Agent Model Used
*A ser preenchido*

### Debug Log References
*A ser preenchido*

### Completion Notes List
*A ser preenchido*

### File List
*A ser preenchido*

## QA Results
*Esta seção será preenchida pelo agente QA após revisão*
